<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium Explore - Bulgaria Local Experience</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .premium-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .preference-filter {
            background: transparent;
            color: #333;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .preference-filter h3 {
            margin: 0 0 10px 0;
            font-size: 20px;
            text-align: center;
        }
        
        .preference-filter p {
            margin: 0 0 20px 0;
            font-size: 14px;
            text-align: center;
            opacity: 0.9;
        }
        
        .filter-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .filter-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #2e7d32;
            position: relative;
        }
        
        .filter-option:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }
        
        .filter-option input[type="checkbox"] {
            display: none;
        }
        
        
        .filter-option input[type="checkbox"]:checked + .filter-icon + .filter-text {
            color: #ffd700;
        }
        
        .filter-option input[type="checkbox"]:checked ~ * {
            color: #ffd700;
        }
        
        .filter-option:has(input[type="checkbox"]:checked) {
            background: rgba(255,215,0,0.2);
            border-color: #ffd700;
        }
        
        .filter-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .filter-text {
            font-size: 12px;
            font-weight: 500;
            text-align: center;
        }
        
        .filter-button-container {
            text-align: center;
            margin: 20px 0;
        }
        
        .filter-button {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .filter-button:hover {
            background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .filter-button i {
            font-size: 14px;
        }
        
        .recommendations {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .recommendations h4 {
            margin: 0 0 15px 0;
            font-size: 16px;
            text-align: center;
        }
        
        .recommended-cities {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .recommended-city {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .recommended-city:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }
        
        .recommended-city h5 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #ffd700;
        }
        
        .recommended-city p {
            margin: 0;
            font-size: 12px;
            opacity: 0.8;
        }
        
        .premium-city-card {
            position: relative;
        }
        
        .premium-city-card .premium-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .ar-experience-section {
            margin-top: 15px;
        }
        
        .ar-experience-button {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1000;
            pointer-events: auto;
        }
        
        .ar-experience-button:hover {
            background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .ar-experience-button i {
            font-size: 16px;
        }
        
        .ar-blank-space {
            height: 0;
            transition: height 0.3s ease;
            overflow: hidden;
        }
        
        .ar-blank-space.show {
            height: 100px;
        }
        
    </style>
</head>
<body>
    <!-- Subtle Background Pattern -->
    <div class="subtle-background" id="subtleBackground"></div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1 class="title">Premium Explore</h1>
                <p class="subtitle">Unlock exclusive experiences with AI personalization</p>
            </div>
        </header>


        <div class="preference-filter">
            <h3>Find Your Perfect Cities</h3>
            <p>Select your interests to get personalized city recommendations</p>
            
            <div class="filter-options">
                <label class="filter-option">
                    <input type="checkbox" value="mountains" onchange="handleFilterChange(this)">
                    <span class="filter-icon">‚õ∞Ô∏è</span>
                    <span class="filter-text">Mountains</span>
                </label>
                
                <label class="filter-option">
                    <input type="checkbox" value="history" onchange="handleFilterChange(this)">
                    <span class="filter-icon">üèõÔ∏è</span>
                    <span class="filter-text">History</span>
                </label>
                
                <label class="filter-option">
                    <input type="checkbox" value="wine" onchange="handleFilterChange(this)">
                    <span class="filter-icon">üç∑</span>
                    <span class="filter-text">Wine</span>
                </label>
                
                <label class="filter-option">
                    <input type="checkbox" value="nature" onchange="handleFilterChange(this)">
                    <span class="filter-icon">üåø</span>
                    <span class="filter-text">Nature</span>
                </label>
                
                <label class="filter-option">
                    <input type="checkbox" value="culture" onchange="handleFilterChange(this)">
                    <span class="filter-icon">üé≠</span>
                    <span class="filter-text">Culture</span>
                </label>
                
                <label class="filter-option">
                    <input type="checkbox" value="architecture" onchange="handleFilterChange(this)">
                    <span class="filter-icon">üè∞</span>
                    <span class="filter-text">Architecture</span>
                </label>
            </div>
            
            <div class="filter-button-container">
                <button class="filter-button" id="filterButton" onclick="doFilter()">
                    <i class="fas fa-filter"></i>
                    <span>Filter</span>
                </button>
            </div>
            
            <div class="recommendations" id="recommendations" style="display: none;">
                <h4>Your Top 3 Recommendations</h4>
                <div class="recommended-cities" id="recommendedCities">
                    <!-- Dynamic recommendations will appear here -->
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Cities Section -->
            <section class="cities-section">
                <div class="city-section">
                    <h2 class="section-title">Choose Your Premium City</h2>
                    <div class="city-grid">
                        <div class="city-card premium-city-card" data-city="topolovgrad">
                            <div class="city-info">
                                <h3 class="city-name">Topolovgrad</h3>
                                <p class="city-region">Haskovo</p>
                                <p class="city-population">Pop: 5.4K</p>
                            </div>
                            <i class="fas fa-map-marker-alt city-icon"></i>
                        </div>

                        <div class="city-card premium-city-card" data-city="sevlievo">
                            <div class="city-info">
                                <h3 class="city-name">Sevlievo</h3>
                                <p class="city-region">Gabrovo</p>
                                <p class="city-population">Pop: 24K</p>
                            </div>
                            <i class="fas fa-map-marker-alt city-icon"></i>
                        </div>

                        <div class="city-card premium-city-card" data-city="ruse">
                            <div class="city-info">
                                <h3 class="city-name">Ruse</h3>
                                <p class="city-region">Ruse</p>
                                <p class="city-population">Pop: 144K</p>
                            </div>
                            <i class="fas fa-map-marker-alt city-icon"></i>
                        </div>

                        <div class="city-card premium-city-card" data-city="belene">
                            <div class="city-info">
                                <h3 class="city-name">Belene</h3>
                                <p class="city-region">Pleven</p>
                                <p class="city-population">Pop: 8.5K</p>
                            </div>
                            <i class="fas fa-map-marker-alt city-icon"></i>
                        </div>

                        <div class="city-card premium-city-card" data-city="veliko-tarnovo">
                            <div class="city-info">
                                <h3 class="city-name">Veliko Tarnovo</h3>
                                <p class="city-region">Veliko Tarnovo</p>
                                <p class="city-population">Pop: 66K</p>
                            </div>
                            <i class="fas fa-map-marker-alt city-icon"></i>
                        </div>

                        <div class="city-card premium-city-card" data-city="lovech">
                            <div class="city-info">
                                <h3 class="city-name">Lovech</h3>
                                <p class="city-region">Lovech</p>
                                <p class="city-population">Pop: 36K</p>
                            </div>
                            <i class="fas fa-map-marker-alt city-icon"></i>
                        </div>

                        <div class="city-card premium-city-card" data-city="batak">
                            <div class="city-info">
                                <h3 class="city-name">Batak</h3>
                                <p class="city-region">Pazardzhik</p>
                                <p class="city-population">Pop: 3.4K</p>
                            </div>
                            <i class="fas fa-map-marker-alt city-icon"></i>
                        </div>

                        <div class="city-card premium-city-card" data-city="koprivshtitsa">
                            <div class="city-info">
                                <h3 class="city-name">Koprivshtitsa</h3>
                                <p class="city-region">Sofia</p>
                                <p class="city-population">Pop: 2.4K</p>
                            </div>
                            <i class="fas fa-map-marker-alt city-icon"></i>
                        </div>

                        <div class="city-card premium-city-card" data-city="melnik">
                            <div class="city-info">
                                <h3 class="city-name">Melnik</h3>
                                <p class="city-region">Blagoevgrad</p>
                                <p class="city-population">Pop: 385</p>
                            </div>
                            <i class="fas fa-map-marker-alt city-icon"></i>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Map Section -->
            <section class="map-section">
                <div class="map-container">
                    <div id="map"></div>
                    <button id="resetBtn" class="reset-button" style="display: none;">
                        <i class="fas fa-sync-alt"></i>
                        Reset View
                    </button>
                </div>
            </section>
        </div>

        <!-- Selected City Details -->
        <section id="selectedCityDetails" class="selected-city-details" style="display: none;">
            <div class="city-details-content">
                <h2 id="selectedCityTitle" class="selected-city-title"></h2>
                <p id="selectedCityDescription" class="selected-city-description"></p>
                <button class="explore-button" id="exploreButton">
                    <span>Start Premium Tour</span>
                    <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </section>
        </div>

        <!-- Experience Content Section -->
        <section id="experienceContent" class="experience-content-section" style="display: none;">
            <div class="experience-layout">
                <!-- Left Side - Tour Stops -->
                <div class="tour-stops-wrapper">
                    <h3 class="experience-content-title">AI-Personalized Tour Stops</h3>
                    <div class="stops-list" id="tourStopsList">
                        <!-- Dynamic content will be loaded here -->
                    </div>
                    
                    <div class="hidden-gem-section">
                        <h4 class="hidden-gem-title">Exclusive Hidden Gem</h4>
                        <p class="hidden-gem-text" id="hiddenGemText">
                            <!-- Dynamic content will be loaded here -->
                        </p>
                    </div>
                    
                    <div class="audio-guide-section">
                        <button class="audio-guide-button" onclick="startAudioGuide()">
                            <i class="fas fa-volume-up"></i>
                            <span>Premium Audio Guide</span>
                        </button>
                    </div>
                    
                    <div class="ar-experience-section">
                        <button class="ar-experience-button" onclick="if (!selectedCity) { alert('Please select a city first!'); return; } const cityData = BULGARIAN_CITIES[selectedCity]; const arUrl = `ar-experience.html?city=${encodeURIComponent(selectedCity)}&data=${encodeURIComponent(JSON.stringify(cityData))}`; window.location.href = arUrl;" type="button">
                            <i class="fas fa-cube"></i>
                            <span>AR Experience</span>
                        </button>
                        <div id="arExperienceSpace" class="ar-blank-space"></div>
                    </div>
                </div>

                <!-- Right Side - Attraction Photos -->
                <div class="attractions-photos-wrapper">
                    <h3 class="photos-title" id="photosTitle">Premium Attractions</h3>
                    <div class="photos-grid" id="attractionsGrid">
                        <!-- Dynamic content will be loaded here -->
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        // Global functions - declare immediately
        window.showBestCities = function() {
            alert('Function called!');
            console.log('Filter button clicked!');
            
            try {
                const checkedOptions = Array.from(document.querySelectorAll('.filter-option input[type="checkbox"]:checked'))
                    .map(input => input.value);
                
                console.log('Selected filters:', checkedOptions);
                
                if (checkedOptions.length === 0) {
                    alert('Please select at least one interest to see recommendations!');
                    return;
                }
                
                // Get top 3 cities based on tour stops matching the selected filters
                const topCities = getTopCitiesByTourStops(checkedOptions);
                console.log('Top cities:', topCities);
                
                if (topCities.length === 0) {
                    alert('No cities found matching your selected interests. Try different combinations!');
                    return;
                }
                
                // Show map and filter cities
                showFilteredCities(topCities, checkedOptions);
                
            } catch (error) {
                console.error('Error in showBestCities:', error);
                alert('Error: ' + error.message);
            }
        };
        
        function getTopCitiesByTourStops(selectedFilters) {
            // Tour stops data structure based on your table
            const tourStopsData = {
                "topolovgrad": [
                    {"name": "Town Center - St. George Church", "categories": ["history", "architecture"]},
                    {"name": "Hlyabovo - Thracian Dolmens", "categories": ["history", "mountains"]},
                    {"name": "Sakar Mountain Walk", "categories": ["mountains", "nature"]},
                    {"name": "Local Winery Visit", "categories": ["wine"]}
                ],
                "sevlievo": [
                    {"name": "Hotalich Fortress", "categories": ["history", "architecture", "mountains"]},
                    {"name": "Clock Tower", "categories": ["history", "architecture"]},
                    {"name": "Town History Museum", "categories": ["culture", "history"]},
                    {"name": "Rositsa River Walk", "categories": ["nature"]}
                ],
                "ruse": [
                    {"name": "Freedom Square", "categories": ["architecture", "culture"]},
                    {"name": "Dohodno Zdanie", "categories": ["architecture", "history"]},
                    {"name": "Danube Promenade", "categories": ["nature", "culture"]},
                    {"name": "Ivanovo Rock Churches", "categories": ["history", "architecture"]}
                ],
                "belene": [
                    {"name": "Persin Island", "categories": ["nature"]},
                    {"name": "Belene Prison Memorial", "categories": ["history"]},
                    {"name": "Danube Riverside Walk", "categories": ["nature"]},
                    {"name": "Fishermen Boat Ride", "categories": ["nature"]}
                ],
                "veliko-tarnovo": [
                    {"name": "Tsarevets Fortress", "categories": ["history", "architecture"]},
                    {"name": "Samovodska Charshia", "categories": ["culture"]},
                    {"name": "Yantra River Viewpoints", "categories": ["nature", "architecture"]},
                    {"name": "Sound & Light Show", "categories": ["culture"]}
                ],
                "lovech": [
                    {"name": "Covered Bridge", "categories": ["architecture", "culture"]},
                    {"name": "Varosha Quarter", "categories": ["architecture", "culture"]},
                    {"name": "Hisarya Fortress", "categories": ["history", "architecture"]},
                    {"name": "Stratesh Hill Park", "categories": ["nature"]}
                ],
                "batak": [
                    {"name": "St. Nedelya Church", "categories": ["history", "architecture"]},
                    {"name": "Batak Dam", "categories": ["nature", "mountains"]},
                    {"name": "Rhodopes Trails", "categories": ["mountains", "nature"]},
                    {"name": "Historical Museum", "categories": ["culture", "history"]}
                ],
                "koprivshtitsa": [
                    {"name": "Revival Houses", "categories": ["architecture", "history"]},
                    {"name": "Assumption Church", "categories": ["architecture", "history"]},
                    {"name": "Stone Bridges", "categories": ["architecture"]},
                    {"name": "National Folklore Festival", "categories": ["culture"]}
                ],
                "melnik": [
                    {"name": "Kordopulova House", "categories": ["architecture", "history", "wine"]},
                    {"name": "Melnik Sand Pyramids", "categories": ["nature", "mountains"]},
                    {"name": "Wine Cellars", "categories": ["wine"]},
                    {"name": "Rozhen Monastery", "categories": ["history", "architecture"]}
                ]
            };
            
            // Calculate scores based on matching tour stops
            const cityScores = {};
            Object.keys(tourStopsData).forEach(city => {
                let score = 0;
                tourStopsData[city].forEach(tourStop => {
                    // Count how many categories of this tour stop match selected filters
                    const matchingCategories = tourStop.categories.filter(category => 
                        selectedFilters.includes(category)
                    ).length;
                    score += matchingCategories;
                });
                cityScores[city] = score;
            });
            
            // Get top 3 cities with highest scores, with consistent ordering
            const topCities = Object.entries(cityScores)
                .filter(([city, score]) => score > 0)
                .sort(([cityA, scoreA], [cityB, scoreB]) => {
                    // First sort by score (highest first)
                    if (scoreB !== scoreA) {
                        return scoreB - scoreA;
                    }
                    // If scores are equal, sort alphabetically by city name for consistency
                    return cityA.localeCompare(cityB);
                })
                .slice(0, 3)
                .map(([city]) => city);
            
            console.log('City scores:', cityScores);
            console.log('Top cities:', topCities);
            
            return topCities;
        }
        
        function showFilteredCities(cities, selectedFilters) {
            console.log('showFilteredCities called with:', cities, selectedFilters);
            
            // Show the map section
            const mapSection = document.querySelector('.map-section');
            if (mapSection) {
                mapSection.style.display = 'block';
            }
            
            // Hide all city cards first
            const allCityCards = document.querySelectorAll('.city-card');
            allCityCards.forEach(card => {
                card.style.display = 'none';
            });
            
            // Hide all city cards first
            const allCityCards = document.querySelectorAll('.city-card');
            allCityCards.forEach(card => {
                card.style.display = 'none';
            });
            
            // Show only the top 3 filtered cities with rank badges
            cities.forEach((city, index) => {
                const cityCard = document.querySelector(`[data-city="${city}"]`);
                if (cityCard) {
                    cityCard.style.display = 'block';
                    
                    // Remove any existing rank badge first
                    const existingBadge = cityCard.querySelector('.city-rank-badge');
                    if (existingBadge) {
                        existingBadge.remove();
                    }
                    
                    // Add a rank indicator
                    const badge = document.createElement('div');
                    badge.className = 'city-rank-badge';
                    badge.textContent = `#${index + 1}`;
                    badge.style.cssText = `
                        position: absolute;
                        top: 10px;
                        right: 10px;
                        background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
                        color: #333;
                        padding: 5px 10px;
                        border-radius: 15px;
                        font-weight: bold;
                        font-size: 12px;
                        z-index: 10;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                    `;
                    cityCard.style.position = 'relative';
                    cityCard.appendChild(badge);
                }
            });
            
            // Hide the preference filter section
            const preferenceFilter = document.querySelector('.preference-filter');
            if (preferenceFilter) {
                preferenceFilter.style.display = 'none';
            }
            
            // Add a "Clear Filter" button
            addClearFilterButton();
            
            console.log('Filtered cities displayed');
        }
        
        function addClearFilterButton() {
            // Remove existing clear button if any
            const existingButton = document.querySelector('.clear-filter-button');
            if (existingButton) {
                existingButton.remove();
            }
            
            // Add clear filter button
            const clearButton = document.createElement('button');
            clearButton.className = 'clear-filter-button';
            clearButton.innerHTML = '<i class="fas fa-times"></i> Clear Filter';
            clearButton.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 25px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
                z-index: 1000;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                transition: all 0.3s ease;
            `;
            
            clearButton.addEventListener('click', clearFilter);
            document.body.appendChild(clearButton);
        }
        
        function clearFilter() {
            // Show all city cards
            const allCityCards = document.querySelectorAll('.city-card');
            allCityCards.forEach(card => {
                card.style.display = 'block';
                // Remove rank badges
                const rankBadge = card.querySelector('.city-rank-badge');
                if (rankBadge) {
                    rankBadge.remove();
                }
            });
            
            // Show preference filter section
            const preferenceFilter = document.querySelector('.preference-filter');
            if (preferenceFilter) {
                preferenceFilter.style.display = 'block';
            }
            
            // Remove clear filter button
            const clearButton = document.querySelector('.clear-filter-button');
            if (clearButton) {
                clearButton.remove();
            }
            
            // Uncheck all filter checkboxes
            const checkboxes = document.querySelectorAll('.filter-option input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            console.log('Filter cleared');
        }
        
        
    </script>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="script.js"></script>
    <script>
        function doFilter() {
            const checked = document.querySelectorAll('.filter-option input[type=checkbox]:checked');
            const selectedFilters = Array.from(checked).map(cb => cb.value);
            
            if (selectedFilters.length === 0) {
                alert('Please select at least one interest!');
                return;
            }
            
            // Tour stops data based on your table
            const tourStopsData = {
                'topolovgrad': [
                    {'categories': ['history', 'architecture']},
                    {'categories': ['history', 'mountains']},
                    {'categories': ['mountains', 'nature']},
                    {'categories': ['wine']}
                ],
                'sevlievo': [
                    {'categories': ['history', 'architecture', 'mountains']},
                    {'categories': ['history', 'architecture']},
                    {'categories': ['culture', 'history']},
                    {'categories': ['nature']}
                ],
                'ruse': [
                    {'categories': ['architecture', 'culture']},
                    {'categories': ['architecture', 'history']},
                    {'categories': ['nature', 'culture']},
                    {'categories': ['history', 'architecture']}
                ],
                'belene': [
                    {'categories': ['nature']},
                    {'categories': ['history']},
                    {'categories': ['nature']},
                    {'categories': ['nature']}
                ],
                'veliko-tarnovo': [
                    {'categories': ['history', 'architecture']},
                    {'categories': ['culture']},
                    {'categories': ['nature', 'architecture']},
                    {'categories': ['culture']}
                ],
                'lovech': [
                    {'categories': ['architecture', 'culture']},
                    {'categories': ['architecture', 'culture']},
                    {'categories': ['history', 'architecture']},
                    {'categories': ['nature']}
                ],
                'batak': [
                    {'categories': ['history', 'architecture']},
                    {'categories': ['nature', 'mountains']},
                    {'categories': ['mountains', 'nature']},
                    {'categories': ['culture', 'history']}
                ],
                'koprivshtitsa': [
                    {'categories': ['architecture', 'history']},
                    {'categories': ['architecture', 'history']},
                    {'categories': ['architecture']},
                    {'categories': ['culture']}
                ],
                'melnik': [
                    {'categories': ['architecture', 'history', 'wine']},
                    {'categories': ['nature', 'mountains']},
                    {'categories': ['wine']},
                    {'categories': ['history', 'architecture']}
                ]
            };
            
            // Calculate scores for each city
            const cityScores = {};
            Object.keys(tourStopsData).forEach(city => {
                let score = 0;
                tourStopsData[city].forEach(tourStop => {
                    const matchingCategories = tourStop.categories.filter(category => 
                        selectedFilters.includes(category)
                    ).length;
                    score += matchingCategories;
                });
                cityScores[city] = score;
            });
            
            // Get top 3 cities with highest scores
            const topCities = Object.entries(cityScores)
                .filter(([city, score]) => score > 0)
                .sort(([cityA, scoreA], [cityB, scoreB]) => {
                    if (scoreB !== scoreA) {
                        return scoreB - scoreA;
                    }
                    return cityA.localeCompare(cityB);
                })
                .slice(0, 3)
                .map(([city]) => city);
            
            // Hide all cities first
            document.querySelectorAll('.city-card').forEach(card => {
                card.style.display = 'none';
                const existingBadge = card.querySelector('.city-rank-badge');
                if (existingBadge) {
                    existingBadge.remove();
                }
            });
            
            // Show only the top 3 cities (no rank badges)
            topCities.forEach((city) => {
                const card = document.querySelector('[data-city=' + city + ']');
                if (card) {
                    card.style.display = 'block';
                }
            });
            
            // Show map
            const mapSection = document.querySelector('.map-section');
            if (mapSection) mapSection.style.display = 'block';
            
            // Hide filter section
            const filterSection = document.querySelector('.preference-filter');
            if (filterSection) filterSection.style.display = 'none';
            
            // Add clear filter button
            const existingClearButton = document.querySelector('.clear-filter-button');
            if (existingClearButton) existingClearButton.remove();
            
            const clearButton = document.createElement('button');
            clearButton.className = 'clear-filter-button';
            clearButton.innerHTML = '<i class="fas fa-times"></i> Clear Filter';
            clearButton.style.cssText = 'position:fixed;top:20px;right:20px;background:#f8f9fa;color:#6c757d;border:2px solid #dee2e6;padding:10px 16px;border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;display:flex;align-items:center;gap:6px;z-index:1000;box-shadow:0 2px 4px rgba(0,0,0,0.1);transition:all 0.2s ease;';
            clearButton.onclick = function() {
                document.querySelectorAll('.city-card').forEach(card => {
                    card.style.display = 'block';
                });
                const preferenceFilter = document.querySelector('.preference-filter');
                if (preferenceFilter) preferenceFilter.style.display = 'block';
                clearButton.remove();
                document.querySelectorAll('.filter-option input[type=checkbox]').forEach(checkbox => {
                    checkbox.checked = false;
                });
            };
            document.body.appendChild(clearButton);
        }
    </script>
    <script>
        
        // Premium-specific functionality
        let selectedCity = null;
        let map = null;
        
        // Initialize premium page
        document.addEventListener('DOMContentLoaded', function() {
            initializePremiumPage();
            initializeMap();
        });
        
        // Make AR function globally available
        window.startARExperience = function() {
            if (!selectedCity) {
                alert('Please select a city first!');
                return;
            }
            
            const cityData = BULGARIAN_CITIES[selectedCity];
            
            // Navigate to AR experience page with city data
            const arUrl = `ar-experience.html?city=${encodeURIComponent(selectedCity)}&data=${encodeURIComponent(JSON.stringify(cityData))}`;
            window.location.href = arUrl;
        };
        
        
        function initializePremiumPage() {
            console.log('Setting up city cards...');
            const cityCards = document.querySelectorAll('.city-card');
            console.log('Found', cityCards.length, 'city cards');
            cityCards.forEach(card => {
                card.addEventListener('click', function() {
                    selectCity(this.dataset.city);
                });
            });
            
            // Add explore button event listener
            const exploreButton = document.getElementById('exploreButton');
            if (exploreButton) {
                console.log('Setting up explore button');
                exploreButton.addEventListener('click', exploreSelectedCity);
            } else {
                console.log('Explore button not found');
            }
            
            // Add filter button event listener
            const filterButton = document.getElementById('filterButton');
            if (filterButton) {
                console.log('Setting up filter button');
                // Remove any existing event listeners first
                filterButton.removeEventListener('click', showBestCities);
                filterButton.addEventListener('click', function() {
                    console.log('Filter button clicked via event listener');
                    showBestCities();
                });
            } else {
                console.log('Filter button not found');
            }
            
        }
        
        function initializeMap() {
            // Initialize the map centered on Bulgaria
            map = L.map('map').setView([42.6977, 23.3219], 7);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            // Add city markers
            const cityCoordinates = {
                'topolovgrad': [42.0833, 26.3333],
                'sevlievo': [43.0167, 25.1167],
                'ruse': [43.8564, 25.9569],
                'belene': [43.6500, 25.1167],
                'veliko-tarnovo': [43.0811, 25.6172],
                'lovech': [43.1333, 24.7167],
                'batak': [41.9500, 24.2167],
                'koprivshtitsa': [42.6333, 24.3500],
                'melnik': [41.5167, 23.4000]
            };
            
            Object.keys(cityCoordinates).forEach(city => {
                const coords = cityCoordinates[city];
                const cityData = BULGARIAN_CITIES[city];
                
                const marker = L.marker(coords).addTo(map);
                marker.bindPopup(`
                    <div style="text-align: center;">
                        <h3 style="margin: 0 0 10px 0; color: #2d5a27;">${cityData.name}</h3>
                        <p style="margin: 0; font-size: 14px; color: #666;">${cityData.overview}</p>
                        <button onclick="selectCityFromMap('${city}')" style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 10px; cursor: pointer;">
                            Select City
                        </button>
                    </div>
                `);
            });
        }
        
        function selectCityFromMap(city) {
            selectCity(city);
            // Close popup
            map.closePopup();
        }
        
        function selectCity(city) {
            selectedCity = city;
            
            // Remove previous selection
            document.querySelectorAll('.city-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selection to clicked card
            const selectedCard = document.querySelector(`[data-city="${city}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }
            
            // Update city details
            const cityData = BULGARIAN_CITIES[city];
            if (cityData) {
                document.getElementById('selectedCityTitle').textContent = cityData.name;
                document.getElementById('selectedCityDescription').textContent = cityData.overview;
                document.getElementById('selectedCityDetails').style.display = 'block';
                document.getElementById('selectedCityDetails').scrollIntoView({ behavior: 'smooth', block: 'end' });
            }
        }
        
        function exploreSelectedCity() {
            if (selectedCity) {
                updatePremiumExperienceContent(selectedCity);
                document.getElementById('experienceContent').style.display = 'block';
                document.getElementById('experienceContent').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        function updatePremiumExperienceContent(city) {
            const cityData = BULGARIAN_CITIES[city];
            if (!cityData) return;
            
            // Update tour stops
            const stopsList = document.getElementById('tourStopsList');
            const hiddenGemText = document.getElementById('hiddenGemText');
            const attractionsGrid = document.getElementById('attractionsGrid');
            const photosTitle = document.getElementById('photosTitle');
            
            if (city === 'topolovgrad') {
                // Use the same content as explore.html for Topolovgrad
                stopsList.innerHTML = `
                    <div class="stop-item">
                        <span class="stop-text">Thracian tombs & dolmens</span>
                    </div>
                    <div class="stop-item">
                        <span class="stop-text">Sakar Mountain trails</span>
                    </div>
                    <div class="stop-item">
                        <span class="stop-text">Local ethnographic museum</span>
                    </div>
                `;
                
                hiddenGemText.textContent = 'The hidden Thracian rock sanctuaries';
                
                photosTitle.textContent = 'Main Attractions';
                attractionsGrid.innerHTML = `
                    <div class="photo-item">
                        <img src="https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400&h=300&fit=crop" alt="Thracian Tombs" class="attraction-photo">
                        <div class="photo-caption">
                            <h4 class="photo-title">Thracian Tombs & Dolmens</h4>
                            <p class="photo-description">Ancient burial sites in nearby villages</p>
                        </div>
                    </div>
                    
                    <div class="photo-item">
                        <img src="https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=300&fit=crop" alt="Sakar Mountain" class="attraction-photo">
                        <div class="photo-caption">
                            <h4 class="photo-title">Sakar Mountain Trails</h4>
                            <p class="photo-description">Hiking and birdwatching opportunities</p>
                        </div>
                    </div>
                    
                    <div class="photo-item">
                        <img src="https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400&h=300&fit=crop" alt="Ethnographic Museum" class="attraction-photo">
                        <div class="photo-caption">
                            <h4 class="photo-title">Local Ethnographic Museum</h4>
                            <p class="photo-description">Traditional culture and history</p>
                        </div>
                    </div>
                `;
            } else {
                // For other cities, use the existing data structure
                stopsList.innerHTML = '';
                cityData.stops.forEach((stop, index) => {
                    const stopItem = document.createElement('div');
                    stopItem.className = 'stop-item';
                    stopItem.innerHTML = `
                        <span class="stop-text">${stop}</span>
                    `;
                    stopsList.appendChild(stopItem);
                });
                
                hiddenGemText.textContent = cityData.hidden_gem;
                photosTitle.textContent = `${cityData.name} Premium Attractions`;
                
                // For other cities, show a placeholder message
                attractionsGrid.innerHTML = `
                    <div class="photo-item">
                        <div style="background: #f0f0f0; height: 200px; display: flex; align-items: center; justify-content: center; border-radius: 8px;">
                            <p style="color: #666; text-align: center;">Premium attractions coming soon for ${cityData.name}</p>
                        </div>
                    </div>
                `;
            }
        }
        
        function startPremiumAudioGuide() {
            if (!selectedCity) {
                alert('Please select a city first to start the audio guide.');
                return;
            }
            
            // Only show audio guide for Sevlievo (has MP3 files)
            if (selectedCity === 'sevlievo') {
                showSevlievoAudioPlayer();
            } else {
                alert(`Audio guide not yet available for ${BULGARIAN_CITIES[selectedCity].name}. Coming soon!`);
            }
        }
        
        function showSevlievoAudioPlayer() {
            // Remove existing audio player if any
            const existingPlayer = document.getElementById('premiumAudioPlayer');
            if (existingPlayer) {
                existingPlayer.remove();
            }
            
            // Create audio player container
            const audioPlayer = document.createElement('div');
            audioPlayer.id = 'premiumAudioPlayer';
            audioPlayer.className = 'premium-audio-player';
            audioPlayer.innerHTML = `
                <div class="premium-audio-content">
                    <h4 class="premium-audio-title">Premium Audio Guide: Sevlievo</h4>
                    <p class="premium-audio-subtitle">Explore Sevlievo's rich history with our premium audio guide</p>
                    
                    <div class="audio-tracks">
                        <div class="audio-track">
                            <h5>üè∞ Hotalich Fortress</h5>
                            <audio controls preload="metadata" onerror="handleAudioError(this)" onloadstart="handleAudioLoadStart(this)">
                                <source src="Sevlievo_Audio_Guide/Hotalich_Fortress.mp3" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio>
                        </div>
                        
                        <div class="audio-track">
                            <h5>üï∞ Clock Tower & Museum</h5>
                            <audio controls preload="metadata" onerror="handleAudioError(this)" onloadstart="handleAudioLoadStart(this)">
                                <source src="Sevlievo_Audio_Guide/Clock_Tower_Museum.mp3" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio>
                        </div>
                        
                        <div class="audio-track">
                            <h5>üé® Art Gallery</h5>
                            <audio controls preload="metadata" onerror="handleAudioError(this)" onloadstart="handleAudioLoadStart(this)">
                                <source src="Sevlievo_Audio_Guide/Art_Gallery.mp3" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio>
                        </div>
                    </div>
                    
                    <div class="audio-instructions">
                        <p><i class="fas fa-info-circle"></i> Click play on any track to start your audio tour. Each track covers a different attraction in Sevlievo.</p>
                    </div>
                </div>
            `;
            
            // Add to the audio guide section
            const audioGuideSection = document.querySelector('.audio-guide-section');
            audioGuideSection.appendChild(audioPlayer);
            
            // Add CSS for premium audio player
            addPremiumAudioPlayerStyles();
        }
        
        function handleAudioError(audioElement) {
            console.error('Audio loading error:', audioElement.src);
            // Show fallback text if audio fails to load
            const trackDiv = audioElement.closest('.audio-track');
            const fallbackText = getFallbackText(audioElement.src);
            if (fallbackText) {
                trackDiv.innerHTML += `<div class="audio-fallback"><p>${fallbackText}</p></div>`;
            }
        }
        
        function handleAudioLoadStart(audioElement) {
            console.log('Audio loading started:', audioElement.src);
        }
        
        function getFallbackText(audioSrc) {
            const fallbackTexts = {
                'Hotalich_Fortress.mp3': 'Welcome to the Medieval Fortress Hotalich, one of Bulgaria\'s best-preserved historical sites. Located on a hill near Sevlievo, Hotalich dates back to the tenth century. As you walk through the ruins, imagine the life of the medieval town ‚Äî its stone walls, churches, and workshops.',
                'Clock_Tower_Museum.mp3': 'This is the Clock Tower, the oldest public building in Sevlievo, built in 1779. Its elegant octagonal design and carved stone details make it a true local landmark. Just nearby, you\'ll find the Town History Museum, housed in the Hadjistoyan School from 1844.',
                'Art_Gallery.mp3': 'Welcome to the Sevlievo Art Gallery, named after the brothers Asen and Iliya Peykov. The gallery is located in a beautiful nineteenth-century building designed by Austrian architect Josef Schnitter. Inside, you\'ll find inspiring works of Bulgarian art.'
            };
            
            for (const [filename, text] of Object.entries(fallbackTexts)) {
                if (audioSrc.includes(filename)) {
                    return text;
                }
            }
            return null;
        }
        
        function addPremiumAudioPlayerStyles() {
            if (document.getElementById('premiumAudioPlayerStyles')) return;
            
            const style = document.createElement('style');
            style.id = 'premiumAudioPlayerStyles';
            style.textContent = `
                .premium-audio-player {
                    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
                    border: 2px solid #a5d6a7;
                    border-radius: 15px;
                    padding: 25px;
                    margin-top: 20px;
                    box-shadow: 0 6px 20px rgba(165, 214, 167, 0.3);
                }
                
                .premium-audio-content {
                    text-align: center;
                }
                
                .premium-audio-title {
                    font-size: 1.3rem;
                    font-weight: 700;
                    color: #2e7d32;
                    margin: 0 0 8px 0;
                }
                
                .premium-audio-subtitle {
                    font-size: 1rem;
                    color: #666;
                    margin: 0 0 25px 0;
                }
                
                .audio-tracks {
                    display: flex;
                    flex-direction: column;
                    gap: 20px;
                    margin-bottom: 20px;
                }
                
                .audio-track {
                    background: #ffffff;
                    border: 1px solid #e0e0e0;
                    border-radius: 10px;
                    padding: 15px;
                    text-align: left;
                }
                
                .audio-track h5 {
                    font-size: 1.1rem;
                    font-weight: 600;
                    color: #2e7d32;
                    margin: 0 0 10px 0;
                }
                
                .audio-track audio {
                    width: 100%;
                    height: 40px;
                    border-radius: 5px;
                }
                
                .audio-instructions {
                    background: #e8f5e8;
                    border-radius: 8px;
                    padding: 15px;
                    border-left: 4px solid #a5d6a7;
                }
                
                .audio-instructions p {
                    margin: 0;
                    color: #2e7d32;
                    font-size: 0.9rem;
                }
                
                .audio-instructions i {
                    margin-right: 8px;
                    color: #a5d6a7;
                }
                
                .audio-fallback {
                    margin-top: 10px;
                    padding: 10px;
                    background: #fff3cd;
                    border-radius: 5px;
                    border-left: 3px solid #ffc107;
                }
                
                .audio-fallback p {
                    margin: 0;
                    font-size: 0.9rem;
                    color: #856404;
                }
                
                @media (max-width: 768px) {
                    .premium-audio-player {
                        padding: 20px;
                    }
                    
                    .audio-tracks {
                        gap: 15px;
                    }
                    
                    .audio-track {
                        padding: 12px;
                    }
                }
            `;
            document.head.appendChild(style);
        }
        
        // Make function globally accessible
        window.startARExperience = function() {
            alert('AR Experience clicked!');
            
            // Toggle the blank space
            const blankSpace = document.getElementById('arExperienceSpace');
            if (blankSpace) {
                blankSpace.classList.toggle('show');
            }
            
            // Scroll down a little
            window.scrollBy({
                top: 200,
                behavior: 'smooth'
            });
            
            // Add big green square
            addGreenSquare();
            
            if (!selectedCity) {
                alert('Please select a city first!');
                return;
            }
            
            const cityData = BULGARIAN_CITIES[selectedCity];
            createARModal(cityData);
        };
        
        function addGreenSquare() {
            // Remove existing green square if any
            const existingSquare = document.getElementById('greenSquare');
            if (existingSquare) {
                existingSquare.remove();
            }
            
            // Create big green square
            const greenSquare = document.createElement('div');
            greenSquare.id = 'greenSquare';
            greenSquare.style.cssText = `
                width: 300px;
                height: 300px;
                background-color: #4caf50;
                margin: 50px auto;
                border-radius: 15px;
                box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 24px;
                font-weight: bold;
                text-align: center;
                animation: fadeInScale 0.5s ease-out;
            `;
            
            greenSquare.innerHTML = `
                <div>
                    <div style="font-size: 48px; margin-bottom: 10px;">üöÄ</div>
                    <div>AR Experience</div>
                    <div style="font-size: 16px; margin-top: 10px; opacity: 0.9;">Activated!</div>
                </div>
            `;
            
            // Add CSS animation
            if (!document.getElementById('greenSquareStyles')) {
                const style = document.createElement('style');
                style.id = 'greenSquareStyles';
                style.textContent = `
                    @keyframes fadeInScale {
                        0% {
                            opacity: 0;
                            transform: scale(0.5);
                        }
                        100% {
                            opacity: 1;
                            transform: scale(1);
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Add to the experience content section
            const experienceContent = document.getElementById('experienceContent');
            if (experienceContent) {
                experienceContent.appendChild(greenSquare);
            } else {
                // If experience content doesn't exist, add to body
                document.body.appendChild(greenSquare);
            }
        }
        
        function createARModal(cityData) {
            // Remove existing AR modal if any
            const existingModal = document.getElementById('arModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create AR modal
            const arModal = document.createElement('div');
            arModal.id = 'arModal';
            arModal.className = 'ar-modal';
            arModal.innerHTML = `
                <div class="ar-modal-content">
                    <div class="ar-modal-header">
                        <h2>üöÄ AR Experience: ${cityData.name}</h2>
                        <button class="ar-close-btn" onclick="closeARModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="ar-modal-body">
                        <div class="ar-image-container">
                            <img src="Ar%20Vr/ChatGPT%20Image%20Oct%205,%202025,%2011_54_48%20AM.png" 
                                 alt="AR Experience for ${cityData.name}" 
                                 class="ar-experience-image"
                                 onload="console.log('AR image loaded successfully')"
                                 onerror="console.error('Failed to load AR image:', this.src); this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <div class="ar-image-fallback" style="display: none; background: #f0f0f0; height: 300px; display: flex; align-items: center; justify-content: center; border-radius: 15px; color: #666;">
                                <p>AR Image Loading...</p>
                            </div>
                            <div class="ar-overlay">
                                <div class="ar-info">
                                    <h3>${cityData.name} AR Experience</h3>
                                    <p>Immerse yourself in the historical and cultural beauty of ${cityData.name}</p>
                                </div>
                            </div>
                        </div>
                        <div class="ar-controls">
                            <button class="ar-control-btn" onclick="toggleARMode()">
                                <i class="fas fa-cube"></i>
                                <span>Toggle AR Mode</span>
                            </button>
                            <button class="ar-control-btn" onclick="takeARScreenshot()">
                                <i class="fas fa-camera"></i>
                                <span>Take Screenshot</span>
                            </button>
                            <button class="ar-control-btn" onclick="shareARExperience()">
                                <i class="fas fa-share"></i>
                                <span>Share Experience</span>
                            </button>
                        </div>
                        <div class="ar-instructions">
                            <h4>AR Instructions:</h4>
                            <ul>
                                <li>üì± Point your device camera at the image above</li>
                                <li>üéØ Tap on the image to activate AR features</li>
                                <li>üîÑ Rotate your device to explore different angles</li>
                                <li>üì∏ Use the camera button to capture your AR experience</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            
            // Add to body
            document.body.appendChild(arModal);
            
            // Add AR modal styles
            addARModalStyles();
            
            // Show modal with animation
            setTimeout(() => {
                arModal.classList.add('show');
            }, 10);
        }
        
        function closeARModal() {
            const arModal = document.getElementById('arModal');
            if (arModal) {
                arModal.classList.remove('show');
                setTimeout(() => {
                    arModal.remove();
                }, 300);
            }
        }
        
        function toggleARMode() {
            const arImage = document.querySelector('.ar-experience-image');
            if (arImage) {
                arImage.classList.toggle('ar-active');
                const isActive = arImage.classList.contains('ar-active');
                alert(isActive ? 'üéØ AR Mode Activated! Point your camera at the image.' : 'AR Mode Deactivated');
            }
        }
        
        function takeARScreenshot() {
            alert('üì∏ Screenshot captured! Your AR experience has been saved to your device.');
        }
        
        function shareARExperience() {
            if (navigator.share) {
                navigator.share({
                    title: `AR Experience: ${BULGARIAN_CITIES[selectedCity].name}`,
                    text: `Check out this amazing AR experience of ${BULGARIAN_CITIES[selectedCity].name}!`,
                    url: window.location.href
                });
            } else {
                alert('üîó Share link copied to clipboard! Share your AR experience with friends.');
            }
        }
        
        function addARModalStyles() {
            if (document.getElementById('arModalStyles')) return;
            
            const style = document.createElement('style');
            style.id = 'arModalStyles';
            style.textContent = `
                .ar-modal {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.9);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    opacity: 0;
                    visibility: hidden;
                    transition: all 0.3s ease;
                }
                
                .ar-modal.show {
                    opacity: 1;
                    visibility: visible;
                }
                
                .ar-modal-content {
                    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
                    border-radius: 20px;
                    width: 90%;
                    max-width: 800px;
                    max-height: 90vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
                    border: 2px solid #ffd700;
                }
                
                .ar-modal-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 20px;
                    border-bottom: 1px solid #333;
                    background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
                    color: #333;
                    border-radius: 18px 18px 0 0;
                }
                
                .ar-modal-header h2 {
                    margin: 0;
                    font-size: 1.5rem;
                    font-weight: 700;
                }
                
                .ar-close-btn {
                    background: none;
                    border: none;
                    font-size: 1.5rem;
                    cursor: pointer;
                    color: #333;
                    padding: 5px;
                    border-radius: 50%;
                    width: 40px;
                    height: 40px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.3s ease;
                }
                
                .ar-close-btn:hover {
                    background: rgba(0, 0, 0, 0.1);
                    transform: scale(1.1);
                }
                
                .ar-modal-body {
                    padding: 20px;
                }
                
                .ar-image-container {
                    position: relative;
                    margin-bottom: 20px;
                    border-radius: 15px;
                    overflow: hidden;
                    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
                }
                
                .ar-experience-image {
                    width: 100%;
                    height: auto;
                    display: block;
                    transition: all 0.3s ease;
                    cursor: pointer;
                }
                
                .ar-experience-image.ar-active {
                    transform: scale(1.05);
                    filter: brightness(1.2) contrast(1.1);
                    box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
                }
                
                .ar-overlay {
                    position: absolute;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
                    padding: 20px;
                    color: white;
                }
                
                .ar-info h3 {
                    margin: 0 0 10px 0;
                    font-size: 1.3rem;
                    color: #ffd700;
                }
                
                .ar-info p {
                    margin: 0;
                    font-size: 1rem;
                    opacity: 0.9;
                }
                
                .ar-controls {
                    display: flex;
                    gap: 15px;
                    margin-bottom: 20px;
                    flex-wrap: wrap;
                }
                
                .ar-control-btn {
                    background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
                    color: white;
                    border: none;
                    padding: 12px 20px;
                    border-radius: 25px;
                    font-size: 14px;
                    font-weight: 500;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    transition: all 0.3s ease;
                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
                }
                
                .ar-control-btn:hover {
                    background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
                    transform: translateY(-2px);
                    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
                }
                
                .ar-instructions {
                    background: rgba(255, 255, 255, 0.1);
                    padding: 20px;
                    border-radius: 15px;
                    border: 1px solid #333;
                }
                
                .ar-instructions h4 {
                    margin: 0 0 15px 0;
                    color: #ffd700;
                    font-size: 1.1rem;
                }
                
                .ar-instructions ul {
                    margin: 0;
                    padding-left: 20px;
                }
                
                .ar-instructions li {
                    margin-bottom: 8px;
                    color: #ccc;
                    line-height: 1.5;
                }
                
                @media (max-width: 768px) {
                    .ar-modal-content {
                        width: 95%;
                        margin: 10px;
                    }
                    
                    .ar-controls {
                        flex-direction: column;
                    }
                    
                    .ar-control-btn {
                        justify-content: center;
                    }
                }
            `;
            document.head.appendChild(style);
        }
        
        function handleFilterChange(checkbox) {
            const checkedOptions = Array.from(document.querySelectorAll('.filter-option input[type="checkbox"]:checked'));
            
            // Limit to maximum 2 selections
            if (checkedOptions.length > 2) {
                checkbox.checked = false;
                alert('You can select maximum 2 interests at a time!');
                return;
            }
            
            // Hide recommendations when filters change
            document.getElementById('recommendations').style.display = 'none';
        }
        
        function updateRecommendations() {
            const checkedOptions = Array.from(document.querySelectorAll('.filter-option input[type="checkbox"]:checked'))
                .map(input => input.value);
            
            if (checkedOptions.length === 0) {
                document.getElementById('recommendations').style.display = 'none';
                return;
            }
            
            // Special case for mountains - show specific 3 cities
            if (checkedOptions.includes('mountains') && checkedOptions.length === 1) {
                const mountainCities = ['batak', 'topolovgrad', 'lovech'];
                displayMountainRecommendations(mountainCities);
                return;
            }
            
            // City tags based on their characteristics
            const cityTags = {
                'topolovgrad': ['mountains', 'history', 'nature'],
                'sevlievo': ['history', 'culture', 'architecture'],
                'ruse': ['architecture', 'history', 'culture'],
                'belene': ['nature', 'history'],
                'veliko-tarnovo': ['history', 'architecture', 'culture'],
                'lovech': ['mountains', 'nature', 'history', 'architecture'],
                'batak': ['mountains', 'history', 'nature'],
                'koprivshtitsa': ['history', 'culture', 'architecture'],
                'melnik': ['wine', 'mountains', 'nature']
            };
            
            // Calculate scores for each city
            const cityScores = {};
            Object.keys(cityTags).forEach(city => {
                cityScores[city] = cityTags[city].filter(tag => checkedOptions.includes(tag)).length;
            });
            
            // Get top 3 cities
            const topCities = Object.entries(cityScores)
                .filter(([city, score]) => score > 0)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 3)
                .map(([city]) => city);
            
            if (topCities.length > 0) {
                displayRecommendations(topCities);
            } else {
                document.getElementById('recommendations').style.display = 'none';
            }
        }
        
        function getTopCitiesByTourStops(selectedFilters) {
            // Tour stops data structure based on your table
            const tourStopsData = {
                "topolovgrad": [
                    {"name": "Town Center - St. George Church", "categories": ["history", "architecture"]},
                    {"name": "Hlyabovo - Thracian Dolmens", "categories": ["history", "mountains"]},
                    {"name": "Sakar Mountain Walk", "categories": ["mountains", "nature"]},
                    {"name": "Local Winery Visit", "categories": ["wine"]}
                ],
                "sevlievo": [
                    {"name": "Hotalich Fortress", "categories": ["history", "architecture", "mountains"]},
                    {"name": "Clock Tower", "categories": ["history", "architecture"]},
                    {"name": "Town History Museum", "categories": ["culture", "history"]},
                    {"name": "Rositsa River Walk", "categories": ["nature"]}
                ],
                "ruse": [
                    {"name": "Freedom Square", "categories": ["architecture", "culture"]},
                    {"name": "Dohodno Zdanie", "categories": ["architecture", "history"]},
                    {"name": "Danube Promenade", "categories": ["nature", "culture"]},
                    {"name": "Ivanovo Rock Churches", "categories": ["history", "architecture"]}
                ],
                "belene": [
                    {"name": "Persin Island", "categories": ["nature"]},
                    {"name": "Belene Prison Memorial", "categories": ["history"]},
                    {"name": "Danube Riverside Walk", "categories": ["nature"]},
                    {"name": "Fishermen Boat Ride", "categories": ["nature"]}
                ],
                "veliko-tarnovo": [
                    {"name": "Tsarevets Fortress", "categories": ["history", "architecture"]},
                    {"name": "Samovodska Charshia", "categories": ["culture"]},
                    {"name": "Yantra River Viewpoints", "categories": ["nature", "architecture"]},
                    {"name": "Sound & Light Show", "categories": ["culture"]}
                ],
                "lovech": [
                    {"name": "Covered Bridge", "categories": ["architecture", "culture"]},
                    {"name": "Varosha Quarter", "categories": ["architecture", "culture"]},
                    {"name": "Hisarya Fortress", "categories": ["history", "architecture"]},
                    {"name": "Stratesh Hill Park", "categories": ["nature"]}
                ],
                "batak": [
                    {"name": "St. Nedelya Church", "categories": ["history", "architecture"]},
                    {"name": "Batak Dam", "categories": ["nature", "mountains"]},
                    {"name": "Rhodopes Trails", "categories": ["mountains", "nature"]},
                    {"name": "Historical Museum", "categories": ["culture", "history"]}
                ],
                "koprivshtitsa": [
                    {"name": "Revival Houses", "categories": ["architecture", "history"]},
                    {"name": "Assumption Church", "categories": ["architecture", "history"]},
                    {"name": "Stone Bridges", "categories": ["architecture"]},
                    {"name": "National Folklore Festival", "categories": ["culture"]}
                ],
                "melnik": [
                    {"name": "Kordopulova House", "categories": ["architecture", "history", "wine"]},
                    {"name": "Melnik Sand Pyramids", "categories": ["nature", "mountains"]},
                    {"name": "Wine Cellars", "categories": ["wine"]},
                    {"name": "Rozhen Monastery", "categories": ["history", "architecture"]}
                ]
            };
            
            // Calculate scores based on matching tour stops
            const cityScores = {};
            Object.keys(tourStopsData).forEach(city => {
                let score = 0;
                tourStopsData[city].forEach(tourStop => {
                    selectedFilters.forEach(filter => {
                        if (tourStop.categories.includes(filter)) {
                            score += 1;
                        }
                    });
                });
                cityScores[city] = score;
            });
            
            // Get top 3 cities
            return Object.entries(cityScores)
                .filter(([city, score]) => score > 0)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 3)
                .map(([city]) => city);
        }
        
        function displayTourStopRecommendations(cities, selectedFilters) {
            console.log('Displaying recommendations for cities:', cities, 'with filters:', selectedFilters);
            
            const recommendationsDiv = document.getElementById('recommendations');
            const recommendedCitiesDiv = document.getElementById('recommendedCities');
            
            if (!recommendationsDiv || !recommendedCitiesDiv) {
                console.error('Recommendations elements not found!');
                return;
            }
            
            recommendedCitiesDiv.innerHTML = '';
            
            // Tour stops data structure (same as in getTopCitiesByTourStops)
            const tourStopsData = {
                "topolovgrad": [
                    {"name": "Town Center - St. George Church", "categories": ["history", "architecture"]},
                    {"name": "Hlyabovo - Thracian Dolmens", "categories": ["history", "mountains"]},
                    {"name": "Sakar Mountain Walk", "categories": ["mountains", "nature"]},
                    {"name": "Local Winery Visit", "categories": ["wine"]}
                ],
                "sevlievo": [
                    {"name": "Hotalich Fortress", "categories": ["history", "architecture", "mountains"]},
                    {"name": "Clock Tower", "categories": ["history", "architecture"]},
                    {"name": "Town History Museum", "categories": ["culture", "history"]},
                    {"name": "Rositsa River Walk", "categories": ["nature"]}
                ],
                "ruse": [
                    {"name": "Freedom Square", "categories": ["architecture", "culture"]},
                    {"name": "Dohodno Zdanie", "categories": ["architecture", "history"]},
                    {"name": "Danube Promenade", "categories": ["nature", "culture"]},
                    {"name": "Ivanovo Rock Churches", "categories": ["history", "architecture"]}
                ],
                "belene": [
                    {"name": "Persin Island", "categories": ["nature"]},
                    {"name": "Belene Prison Memorial", "categories": ["history"]},
                    {"name": "Danube Riverside Walk", "categories": ["nature"]},
                    {"name": "Fishermen Boat Ride", "categories": ["nature"]}
                ],
                "veliko-tarnovo": [
                    {"name": "Tsarevets Fortress", "categories": ["history", "architecture"]},
                    {"name": "Samovodska Charshia", "categories": ["culture"]},
                    {"name": "Yantra River Viewpoints", "categories": ["nature", "architecture"]},
                    {"name": "Sound & Light Show", "categories": ["culture"]}
                ],
                "lovech": [
                    {"name": "Covered Bridge", "categories": ["architecture", "culture"]},
                    {"name": "Varosha Quarter", "categories": ["architecture", "culture"]},
                    {"name": "Hisarya Fortress", "categories": ["history", "architecture"]},
                    {"name": "Stratesh Hill Park", "categories": ["nature"]}
                ],
                "batak": [
                    {"name": "St. Nedelya Church", "categories": ["history", "architecture"]},
                    {"name": "Batak Dam", "categories": ["nature", "mountains"]},
                    {"name": "Rhodopes Trails", "categories": ["mountains", "nature"]},
                    {"name": "Historical Museum", "categories": ["culture", "history"]}
                ],
                "koprivshtitsa": [
                    {"name": "Revival Houses", "categories": ["architecture", "history"]},
                    {"name": "Assumption Church", "categories": ["architecture", "history"]},
                    {"name": "Stone Bridges", "categories": ["architecture"]},
                    {"name": "National Folklore Festival", "categories": ["culture"]}
                ],
                "melnik": [
                    {"name": "Kordopulova House", "categories": ["architecture", "history", "wine"]},
                    {"name": "Melnik Sand Pyramids", "categories": ["nature", "mountains"]},
                    {"name": "Wine Cellars", "categories": ["wine"]},
                    {"name": "Rozhen Monastery", "categories": ["history", "architecture"]}
                ]
            };
            
            cities.forEach(city => {
                const cityData = BULGARIAN_CITIES[city];
                if (!cityData) {
                    console.error('City data not found for:', city);
                    return;
                }
                
                const cityDiv = document.createElement('div');
                cityDiv.className = 'recommended-city';
                cityDiv.onclick = () => selectCity(city);
                
                // Find relevant tour stops based on selected filters
                const relevantStops = tourStopsData[city].filter(tourStop => 
                    tourStop.categories.some(category => selectedFilters.includes(category))
                ).slice(0, 3); // Limit to 3 stops
                
                console.log(`City: ${city}, Relevant stops:`, relevantStops);
                
                cityDiv.innerHTML = `
                    <h5>${cityData.name}</h5>
                    <p><strong>Relevant Tour Stops:</strong></p>
                    <ul style="margin: 5px 0; padding-left: 15px; font-size: 12px;">
                        ${relevantStops.map(stop => `<li>${stop.name}</li>`).join('')}
                    </ul>
                `;
                
                recommendedCitiesDiv.appendChild(cityDiv);
            });
            
            console.log('Setting recommendations display to block');
            recommendationsDiv.style.display = 'block';
        }
        
        function displayRecommendations(cities) {
            const recommendationsDiv = document.getElementById('recommendations');
            const recommendedCitiesDiv = document.getElementById('recommendedCities');
            
            recommendedCitiesDiv.innerHTML = '';
            
            cities.forEach(city => {
                const cityData = BULGARIAN_CITIES[city];
                const cityDiv = document.createElement('div');
                cityDiv.className = 'recommended-city';
                cityDiv.onclick = () => selectCity(city);
                
                cityDiv.innerHTML = `
                    <h5>${cityData.name}</h5>
                    <p>${cityData.overview}</p>
                `;
                
                recommendedCitiesDiv.appendChild(cityDiv);
            });
            
            recommendationsDiv.style.display = 'block';
        }
        
        function showFilteredCities(cities, selectedFilters) {
            console.log('showFilteredCities called with:', cities, selectedFilters);
            
            // Show the map section
            const mapSection = document.querySelector('.map-section');
            if (mapSection) {
                mapSection.style.display = 'block';
            }
            
            // Hide all city cards first
            const allCityCards = document.querySelectorAll('.city-card');
            allCityCards.forEach(card => {
                card.style.display = 'none';
            });
            
            // Hide all city cards first
            const allCityCards = document.querySelectorAll('.city-card');
            allCityCards.forEach(card => {
                card.style.display = 'none';
            });
            
            // Show only the top 3 filtered cities with rank badges
            cities.forEach((city, index) => {
                const cityCard = document.querySelector(`[data-city="${city}"]`);
                if (cityCard) {
                    cityCard.style.display = 'block';
                    
                    // Remove any existing rank badge first
                    const existingBadge = cityCard.querySelector('.city-rank-badge');
                    if (existingBadge) {
                        existingBadge.remove();
                    }
                    
                    // Add a rank indicator
                    const badge = document.createElement('div');
                    badge.className = 'city-rank-badge';
                    badge.textContent = `#${index + 1}`;
                    badge.style.cssText = `
                        position: absolute;
                        top: 10px;
                        right: 10px;
                        background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
                        color: #333;
                        padding: 5px 10px;
                        border-radius: 15px;
                        font-weight: bold;
                        font-size: 12px;
                        z-index: 10;
                        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                    `;
                    cityCard.style.position = 'relative';
                    cityCard.appendChild(badge);
                }
            });
            
            // Hide the preference filter section
            const preferenceFilter = document.querySelector('.preference-filter');
            if (preferenceFilter) {
                preferenceFilter.style.display = 'none';
            }
            
            // Add a "Clear Filter" button
            addClearFilterButton();
            
            console.log('Filtered cities displayed');
        }
        
        function addClearFilterButton() {
            // Remove existing clear button if any
            const existingButton = document.querySelector('.clear-filter-button');
            if (existingButton) {
                existingButton.remove();
            }
            
            // Add clear filter button
            const clearButton = document.createElement('button');
            clearButton.className = 'clear-filter-button';
            clearButton.innerHTML = '<i class="fas fa-times"></i> Clear Filter';
            clearButton.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 25px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
                z-index: 1000;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                transition: all 0.3s ease;
            `;
            
            clearButton.addEventListener('click', clearFilter);
            document.body.appendChild(clearButton);
        }
        
        function clearFilter() {
            // Show all city cards
            const allCityCards = document.querySelectorAll('.city-card');
            allCityCards.forEach(card => {
                card.style.display = 'block';
                // Remove rank badges
                const rankBadge = card.querySelector('.city-rank-badge');
                if (rankBadge) {
                    rankBadge.remove();
                }
            });
            
            // Show preference filter section
            const preferenceFilter = document.querySelector('.preference-filter');
            if (preferenceFilter) {
                preferenceFilter.style.display = 'block';
            }
            
            // Remove clear filter button
            const clearButton = document.querySelector('.clear-filter-button');
            if (clearButton) {
                clearButton.remove();
            }
            
            // Uncheck all filter checkboxes
            const checkboxes = document.querySelectorAll('.filter-option input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            console.log('Filter cleared');
        }
        
    </script>
</body>
</html>
